<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>Recommender Systems</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<link href="site_libs/highlightjs-1.1/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-1.1/highlight.js"></script>
<link href="site_libs/font-awesome-4.5.0/css/font-awesome.min.css" rel="stylesheet" />

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="mystyle.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 60px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 65px;
  margin-top: -65px;
}

.section h2 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h3 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h4 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h5 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h6 {
  padding-top: 65px;
  margin-top: -65px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>




<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Real Business Analytics</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="plenary.html">The Project</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Case Studies
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="courseRBA_1.html">R and Rmarkdown</a>
    </li>
    <li>
      <a href="courseRBA_2.html">Recommender Systems</a>
    </li>
    <li>
      <a href="shortcourse_sofr.html">Indicators</a>
    </li>
    <li>
      <a href="shortcourse_fosr.html">Stress Test</a>
    </li>
    <li>
      <a href="shortcourse_other.html">Clustering</a>
    </li>
    <li>
      <a href="shortcourse_other2.html">Multiple System Estimation</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="about.html">About</a>
</li>
<li>
  <a href="https://github.com/">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">

<div class="btn-group pull-right">
<button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Recommender Systems</h1>

</div>


<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>Almost every people has receipt a recommendation from some Recommender System even if he/she has never heard about it. Selling websites like Amazon or simple browsers as Googleâs are training models from data in order to provide the best product or website to their customers given some information such as sociodemographic characteristics, historical purchased products or likes in websites. Obviously, Recommender Systems (RecSys) are on the spot of many companies and institutions who are trying to provide the most adequate item for a given person.</p>
<p>In this session, we start by reviewing the different typologies of RecSys. Next, we formalize the problem and introduce the data sets of the case study. The first one is related to transactions in a grocery store and the second one contains users and its listened band music. Finally, we build from the scratch different RecSys methods and apply them for providing merchandasing strategies and product/groups recommendations. The code for applying Collaborative Filtering is not efficient since it is implemented by nested loop, however, in this way we can follow easily each step. The RData file that contains all the results can be dowload <a href="courseRBA_2/resultsCase2.RData">here</a>.</p>
<div class="figure">
<img src="courseRBA_2/recSys_example.png" />

</div>
</div>
<div id="the-problem" class="section level2">
<h2>The problem</h2>
<p>Lets denote by <span class="math inline">\(U=\{u_1, u_2,...\}\)</span> the set of total users in the sample and <span class="math inline">\(I=\{i_1,i_2,...\}\)</span> the list of all items (goods or services) that a given user could consume. Our data set will consist in a binary matrix <span class="math inline">\(R\)</span> of dimension <span class="math inline">\(|U| \times |I|\)</span>, being <span class="math inline">\(|A|\)</span> the number of elements in the set <span class="math inline">\(A\)</span>.</p>
<p>The following table represents a data set of <span class="math inline">\(5\)</span> users and <span class="math inline">\(6\)</span> items.</p>
<pre class="r"><code>set.seed(01071991)
R=matrix(rbinom(30,1,0.5), nrow=5, ncol=6)
colnames(R)&lt;-c(&#39;Item 1&#39;, &#39;Item 2&#39;,&#39;Item 3&#39;,&#39;Item 4&#39;,&#39;Item 5&#39;,&#39;Item 6&#39;)
rownames(R)&lt;-c(&#39;User 1&#39;, &#39;User 2&#39;,&#39;User 3&#39;,&#39;User 4&#39;,&#39;User 5&#39;)
kable(R)</code></pre>
<table>
<thead>
<tr class="header">
<th></th>
<th align="right">Item 1</th>
<th align="right">Item 2</th>
<th align="right">Item 3</th>
<th align="right">Item 4</th>
<th align="right">Item 5</th>
<th align="right">Item 6</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>User 1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td>User 2</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td>User 3</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td>User 4</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td>User 5</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1</td>
</tr>
</tbody>
</table>
<p>each cell <span class="math inline">\(R(u_i,i_j)=1\)</span> if the user <span class="math inline">\(u_i\)</span> has bought the product <span class="math inline">\(i_j\)</span> and <span class="math inline">\(0\)</span> otherwise. For instance, the User 1, <span class="math inline">\(u_1\)</span>, consumed <span class="math inline">\(I_{u_1}=\{i_3, i_4, i_6\}\)</span> while the User 3, <span class="math inline">\(u_3\)</span>, bought everything unless the item 4 <span class="math inline">\(I_{u_1}=\{i_1, i_2, i_3, i_5, i_6\}\)</span>.</p>
<p>The main goal of a RecSys is to propose a item to a user that 1) It has not been consumed by him/her but 2) the user would like the new item with high chance. Different definitions of what it is a item with ‘high chance’ yield diferent RecSys.</p>
<div id="groceries-data-set" class="section level3">
<h3>Groceries data set</h3>
<p>This data set gathers a collection of receipts with each line representing 1 receipt and the items purchased. The data set is available from R but it can be downloaded <a href="courseRBA_2/groceries.csv">groceries.csv</a>, however it comes by default with an special format. If the file is open by a plain text editor, one could observe that each row represents a enumeration of products corresponding with the items of a single transaction.</p>
<p>In the following chunk of code, we convert this format to a binary matrix as explained before. Each line is called a transaction and each column in a row represents an item.</p>
<pre class="r"><code>data(Groceries)
Shopping_Cart &lt;- read.transactions(&quot;courseRBA_2/groceries.csv&quot;, sep=&quot;,&quot;)
dataMatrixGrocery&lt;-as(Shopping_Cart, &quot;matrix&quot;)*1; rownames(dataMatrixGrocery)&lt;-c(1:nrow(dataMatrixGrocery))
kable(dataMatrixGrocery[10:15,160:169])</code></pre>
<table>
<thead>
<tr class="header">
<th></th>
<th align="right">UHT-milk</th>
<th align="right">vinegar</th>
<th align="right">waffles</th>
<th align="right">whipped/sour cream</th>
<th align="right">whisky</th>
<th align="right">white bread</th>
<th align="right">white wine</th>
<th align="right">whole milk</th>
<th align="right">yogurt</th>
<th align="right">zwieback</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>10</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td>11</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td>12</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td>13</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td>14</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td>15</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
<p>We have in total 9835 transactions and 169 items. For example, in the transaction number <span class="math inline">\(10\)</span> was bought whole milk and in the number <span class="math inline">\(12\)</span> the client bought whole milk and yogurt among others.</p>
</div>
<div id="last.fm-data-set" class="section level3">
<h3>Last.FM data set</h3>
<p>The data set contains contains information about radio listener in Germany. The original data set contains information about users, their gender, their age, and which artists they have listened. However we will just used the artics that a given users have listened. data about a matrix where each row represents a user, and each column represents and band. The data set we use here can be download <a href="courseRBA_2/lastfmmatrix.csv">here</a>.</p>
<pre class="r"><code>dataMatrixMusicUsers &lt;- read.csv(file=&quot;courseRBA_2/lastfmmatrix.csv&quot;); rownames(dataMatrixMusicUsers)&lt;-dataMatrixMusicUsers[,1]
dataMatrixMusic &lt;- (dataMatrixMusicUsers[,!(names(dataMatrixMusicUsers) %in% c(&quot;user&quot;))])</code></pre>
<p>Lets look at a sample of our data. We have in total 1257 users and 285 different bands. The output looks something like this:</p>
<pre class="r"><code>kable(dataMatrixMusic[20:25,c(1,2:8)])</code></pre>
<table>
<thead>
<tr class="header">
<th></th>
<th align="right">a.perfect.circle</th>
<th align="right">abba</th>
<th align="right">ac.dc</th>
<th align="right">adam.green</th>
<th align="right">aerosmith</th>
<th align="right">afi</th>
<th align="right">air</th>
<th align="right">alanis.morissette</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>383</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td>422</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td>428</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td>438</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td>447</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td>458</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
<p>For example, the user <span class="math inline">\(428\)</span> has listened ACDC.</p>
</div>
</div>
<div id="taxonomy-of-recsys" class="section level2">
<h2>Taxonomy of RecSys</h2>
<p>Mainly, the literature makes a different between:</p>
<ol style="list-style-type: decimal">
<li>Non-personalized and stereotype-based. Best-seller, most popular, trending hot…</li>
<li>Content Based. Uses the article data/information. At its core, content-based recommendation is based on the availability of (manually created or automatically extracted) item descriptions and a profile that assigns importance to these characteristics.</li>
<li>Colaborative Filtering. Use the users interactions with the items(like, viewed, fav).
<ol style="list-style-type: lower-roman">
<li>User based. Similarity between users.</li>
<li>Item based. Similarity between items.</li>
<li>Model based. Parametrized models.</li>
</ol></li>
<li>Hybrid systems. Uses both 1 and 2.</li>
</ol>
<p>The following schema was taken from the arcicle “Recommendation systems: Principles, methods and evaluation” by Isinkaye et al (2015). The only difference is that the authors do not consider the Non-personalized and stereotype-based methods as a RecSys since they are mainly based on descriptive statistics.</p>
<div class="figure">
<img src="courseRBA_2/esquema.PNG" />

</div>
</div>
<div id="contend-based-recsys" class="section level2">
<h2>Contend based RecSys</h2>
<p>Contend based methods take advantage of the information of the product. For example, if an user listens Metallica, a band of metal from the 90s, a possible recommendations would be 1) other bands of metal such as Audioslave, 2) a contemporaneous group such that ACDC, 3) other enemy group (literally) such as Megadeth or 4) a band as Exodus original group of one of the guitar players of Metallica.</p>
</div>
<div id="non-personalized-recsys" class="section level2">
<h2>Non-personalized RecSys</h2>
<p>Method based on descriptive statistics such us mean, mode, maximum, minimum… Below we have two examples, one from Amazon and another from Netflix. On one hand, the first one just recommends the iron machines that have been bought more times. On other hand, Netflix recommend the most times watched films/series.</p>
<center>
<img src="courseRBA_2/16.png" />
</center>
<p>For the Grocery data set one could conclude that milk should be located in a very visible place of the store since is the most common sell as we can see in the following frequency plot,</p>
<pre class="r"><code># Create an item frequency plot for the top 20 items
itemFrequencyPlot(Groceries,topN=20,type=&quot;absolute&quot;)</code></pre>
<p><img src="courseRBA_2_files/figure-html/unnamed-chunk-5-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>About the bands data set, one could recommend to an user the group top ten of the most played, that is</p>
<pre class="r"><code>names(sort(colSums(dataMatrixMusic), decreasing=TRUE)[1:10])
##  [1] &quot;linkin.park&quot;           &quot;coldplay&quot;             
##  [3] &quot;red.hot.chili.peppers&quot; &quot;rammstein&quot;            
##  [5] &quot;system.of.a.down&quot;      &quot;metallica&quot;            
##  [7] &quot;die.toten.hosen&quot;       &quot;billy.talent&quot;         
##  [9] &quot;the.killers&quot;           &quot;the.beatles&quot;</code></pre>
</div>
<div id="colaborative-filtering-recsys" class="section level2">
<h2>Colaborative Filtering RecSys</h2>
<p>The basic idea of these systems is that if users have revealed the same interests in the past â if they listened or bought the same band or product, for instance â they will also have similar tastes in the future. So, if, for example, user <span class="math inline">\(u_{i_1}\)</span> and user <span class="math inline">\(u_{i_2}\)</span> have a history that is strongly similar each other and user <span class="math inline">\(u_{i_1}\)</span> has recently listened a group that <span class="math inline">\(u_{i_2}\)</span> has not, the basic rationale is to propose this group also to <span class="math inline">\(u_{i_2}\)</span>. In this way, the user <span class="math inline">\(u_{i_1}\)</span> <em>collaborates</em> to filter the most promising bands from a large set.</p>
<p>Following this logic one could predict and recommend items to users based on preference similarities. There are three types of collaborative filtering:</p>
<ul>
<li>Association rules.</li>
<li>Item Based Collaborative Filtering takes the <em>similarities</em> between items.</li>
<li>User Based Collaborative Filtering considers <em>similarities</em> between users.</li>
</ul>
<p>Association rules are a data mining technique that by product of an algorithm call ‘appriori’ ends up with a set of relations among items that can be studied with a probability approach. In contrast, the key issue of item based and user based collaborative filterin is how to define similarity. One could think about taking the distance such as <span class="math inline">\(L^P\)</span> or Hausdorff distance,. For example, consider that we want to measure the similarity between items <span class="math inline">\(i_1\)</span> and <span class="math inline">\(i_2\)</span> so its respective vectors are <span class="math inline">\(A=R(,i_1)\)</span> and <span class="math inline">\(B=R(,i_2)\)</span>. We could define the similarity of <span class="math inline">\(i_1\)</span> and <span class="math inline">\(i_2\)</span> as the distance <span class="math inline">\(d(i_1, i_2)=\sum_{j=1}^{|U|}((R(,i_1)-R(,i_2))^p)^{1/p}\)</span> being very similar for values close to 0. However, the most employed measure is the so call Cosine Similarity defined as follows <span class="math display">\[ Similarity(A,B)=\frac{A B}{||A||_2 ||B||_2}=\frac{\sum_{j=1}^{|U|} A_j B_j}{\sqrt(\sum_{j=1}^{|U|}A_j^2)\sqrt(\sum_{j=1}^{|U|}B_j^2)}.\]</span></p>
<p>The important thing to know is that the resulting number represents how âsimilarâ the vector <span class="math inline">\(A\)</span> is with respect the vector <span class="math inline">\(B\)</span>. The following chunk code is a function for computing the similarity between two vectors.</p>
<pre class="r"><code>getCosine &lt;- function(x,y){
    similarity &lt;- sum(x*y) / (sqrt(sum(x*x)) * sqrt(sum(y*y)))
    return(similarity)
}</code></pre>
<div id="association-rules" class="section level3">
<h3>Association Rules</h3>
<p>The outcome of this type of technique, in simple terms, is a set of rules that can be understood as âif this, then thatâ.</p>
<p>This gives us our rules which are represented as follows: <span class="math display">\[ \{ i_1,i_2 \} \rightarrow \{ i_k \}\]</span> Which can be read as âif a user buys an item in the item set on the left hand side, then the user will likely buy the item on the right hand side tooâ. A more human readable example is: <span class="math display">\[ \{coffee,sugar \} \rightarrow \{milk\}\]</span> If a customer buys coffee and sugar, then they are also likely to buy milk. With this we can understand three important ratios; the support, confidence and lift. We describe the significance of these in the following bullet points, but if you are interested in a formal mathematical definition you can find it on <a href="https://en.wikipedia.org/wiki/Association_rule_learning">wikipedia</a>.</p>
<p><strong>Support of item</strong> <span class="math inline">\(i_j\)</span>. The fraction of which our item set occurs in our dataset, in other words, the empirical probability of observing item <span class="math inline">\(i_j\)</span> if we select an item randomly.</p>
<p><strong>Confidence of</strong> <span class="math inline">\(i_{j_1} \rightarrow i_{j_2}\)</span>. Probability that a rule is correct for a new transaction with items on the left. Conditional probability of observing <span class="math inline">\(i_{j_2}\)</span> given that <span class="math inline">\(i_{j_1}\)</span> was observed.</p>
<p><span class="math display">\[P(i_{j_2} | i_{j_1}) = \frac{P(i_{j_2} \cap i_{j_1})}{P(i_{j_1})}\]</span></p>
<p><strong>Lift of</strong> <span class="math inline">\(i_{j_1} \rightarrow i_{j_2}\)</span>. The ratio by which the confidence of a rule exceeds the expected confidence. Probability of the itersecion divided by the product of the probabilities.</p>
<p><span class="math display">\[Lift(i_{j_1} \rightarrow i_{j_2})=\frac{P(i_{j_2} \cap i_{j_1})}{P(i_{j_2}) P( i_{j_1})},\]</span></p>
<p>If this number is <span class="math inline">\(1\)</span> it is because both items are independent.</p>
<p>We are now ready to mine some rules. It will be done by using the packages ‘aules’ and the function ‘apriori’ (name given by the algorithm that computes the rules). This function require a minimum support and confidence. We set the minimum support to 0.001. We set the minimum confidence of 0.8. We then show the top 5 rules,</p>
<pre class="r"><code># Get the rules
rules &lt;- apriori(Groceries, parameter = list(supp = 0.001, conf = 0.8))
## Apriori
## 
## Parameter specification:
##  confidence minval smax arem  aval originalSupport maxtime support minlen
##         0.8    0.1    1 none FALSE            TRUE       5   0.001      1
##  maxlen target   ext
##      10  rules FALSE
## 
## Algorithmic control:
##  filter tree heap memopt load sort verbose
##     0.1 TRUE TRUE  FALSE TRUE    2    TRUE
## 
## Absolute minimum support count: 9 
## 
## set item appearances ...[0 item(s)] done [0.00s].
## set transactions ...[169 item(s), 9835 transaction(s)] done [0.00s].
## sorting and recoding items ... [157 item(s)] done [0.00s].
## creating transaction tree ... done [0.00s].
## checking subsets of size 1 2 3 4 5 6 done [0.01s].
## writing ... [410 rule(s)] done [0.00s].
## creating S4 object  ... done [0.00s].
# Show the top 5 rules, but only 2 digits
options(digits=2)
inspect(rules[1:5])
##     lhs                        rhs            support confidence lift
## [1] {liquor,red/blush wine} =&gt; {bottled beer} 0.0019  0.90       11.2
## [2] {curd,cereals}          =&gt; {whole milk}   0.0010  0.91        3.6
## [3] {yogurt,cereals}        =&gt; {whole milk}   0.0017  0.81        3.2
## [4] {butter,jam}            =&gt; {whole milk}   0.0010  0.83        3.3
## [5] {soups,bottled beer}    =&gt; {whole milk}   0.0011  0.92        3.6</code></pre>
<p>We can call the function summary for obtaining some more information about the result,</p>
<pre class="r"><code>summary(rules)
## set of 410 rules
## 
## rule length distribution (lhs + rhs):sizes
##   3   4   5   6 
##  29 229 140  12 
## 
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##     3.0     4.0     4.0     4.3     5.0     6.0 
## 
## summary of quality measures:
##     support          confidence        lift     
##  Min.   :0.00102   Min.   :0.80   Min.   : 3.1  
##  1st Qu.:0.00102   1st Qu.:0.83   1st Qu.: 3.3  
##  Median :0.00122   Median :0.85   Median : 3.6  
##  Mean   :0.00125   Mean   :0.87   Mean   : 4.0  
##  3rd Qu.:0.00132   3rd Qu.:0.91   3rd Qu.: 4.3  
##  Max.   :0.00315   Max.   :1.00   Max.   :11.2  
## 
## mining info:
##       data ntransactions support confidence
##  Groceries          9835   0.001        0.8</code></pre>
<p>Often we will want the most relevant rules first because, for example, one would want to have the most likely rules. We can easily sort by confidence by executing the following code.</p>
<pre class="r"><code>rules&lt;-sort(rules, by=&quot;confidence&quot;, decreasing=TRUE)
inspect(rules[1:5])
##     lhs                     rhs          support confidence lift
## [1] {rice,                                                      
##      sugar}              =&gt; {whole milk}  0.0012          1  3.9
## [2] {canned fish,                                               
##      hygiene articles}   =&gt; {whole milk}  0.0011          1  3.9
## [3] {root vegetables,                                           
##      butter,                                                    
##      rice}               =&gt; {whole milk}  0.0010          1  3.9
## [4] {root vegetables,                                           
##      whipped/sour cream,                                        
##      flour}              =&gt; {whole milk}  0.0017          1  3.9
## [5] {butter,                                                    
##      soft cheese,                                               
##      domestic eggs}      =&gt; {whole milk}  0.0010          1  3.9</code></pre>
<p>We can limit the number of items by including âmaxlenâ parameter to the apriori function,</p>
<pre class="r"><code>rules &lt;- apriori(Groceries, parameter = list(supp = 0.001, conf = 0.8,maxlen=3))
## Apriori
## 
## Parameter specification:
##  confidence minval smax arem  aval originalSupport maxtime support minlen
##         0.8    0.1    1 none FALSE            TRUE       5   0.001      1
##  maxlen target   ext
##       3  rules FALSE
## 
## Algorithmic control:
##  filter tree heap memopt load sort verbose
##     0.1 TRUE TRUE  FALSE TRUE    2    TRUE
## 
## Absolute minimum support count: 9 
## 
## set item appearances ...[0 item(s)] done [0.00s].
## set transactions ...[169 item(s), 9835 transaction(s)] done [0.00s].
## sorting and recoding items ... [157 item(s)] done [0.00s].
## creating transaction tree ... done [0.00s].
## checking subsets of size 1 2 3
## Warning in apriori(Groceries, parameter = list(supp = 0.001, conf =
## 0.8, : Mining stopped (maxlen reached). Only patterns up to a length of 3
## returned!
##  done [0.00s].
## writing ... [29 rule(s)] done [0.00s].
## creating S4 object  ... done [0.00s].
inspect(rules[1:5])
##     lhs                        rhs            support confidence lift
## [1] {liquor,red/blush wine} =&gt; {bottled beer} 0.0019  0.90       11.2
## [2] {curd,cereals}          =&gt; {whole milk}   0.0010  0.91        3.6
## [3] {yogurt,cereals}        =&gt; {whole milk}   0.0017  0.81        3.2
## [4] {butter,jam}            =&gt; {whole milk}   0.0010  0.83        3.3
## [5] {soups,bottled beer}    =&gt; {whole milk}   0.0011  0.92        3.6</code></pre>
<p>Now that we know how to generate rules, limit the output, lets say we wanted to target items to generate rules. There are two types of targets we might be interested in that are illustrated with an example of âwhole milkâ:</p>
<ul>
<li>What are customers likely to buy before buying whole milk</li>
<li>What are customers likely to buy if they purchase whole milk?</li>
</ul>
<p>This essentially means we want to set either the Left Hand Side and Right Hand Side. This is not difficult to do with R! Answering the first question we adjust our apriori() function as follows:</p>
<pre class="r"><code>rules&lt;-apriori(data=Groceries, parameter=list(supp=0.001,conf = 0.08), 
               appearance = list(default=&quot;lhs&quot;,rhs=&quot;whole milk&quot;),
               control = list(verbose=F))
rules&lt;-sort(rules, decreasing=TRUE,by=&quot;confidence&quot;)
inspect(rules[1:5])
##     lhs                     rhs          support confidence lift
## [1] {rice,                                                      
##      sugar}              =&gt; {whole milk}  0.0012          1  3.9
## [2] {canned fish,                                               
##      hygiene articles}   =&gt; {whole milk}  0.0011          1  3.9
## [3] {root vegetables,                                           
##      butter,                                                    
##      rice}               =&gt; {whole milk}  0.0010          1  3.9
## [4] {root vegetables,                                           
##      whipped/sour cream,                                        
##      flour}              =&gt; {whole milk}  0.0017          1  3.9
## [5] {butter,                                                    
##      soft cheese,                                               
##      domestic eggs}      =&gt; {whole milk}  0.0010          1  3.9</code></pre>
<p>Likewise, we can set the left hand side to be âwhole milkâ and find its antecedents. Note the following:</p>
<ul>
<li>We set the confidence to 0.15 since we get no rules with 0.8</li>
<li>We set a minimum length of 2 to avoid empty left hand side items</li>
</ul>
<pre class="r"><code>rules&lt;-apriori(data=Groceries, parameter=list(supp=0,conf =0.15,minlen=2),appearance=list(default=&quot;rhs&quot;,lhs=&quot;whole milk&quot;),control = list(verbose=F))
rules&lt;-sort(rules, decreasing=TRUE,by=&quot;confidence&quot;)
inspect(rules[1:5])
##     lhs             rhs                support confidence lift
## [1] {whole milk} =&gt; {other vegetables} 0.075   0.29       1.5 
## [2] {whole milk} =&gt; {rolls/buns}       0.057   0.22       1.2 
## [3] {whole milk} =&gt; {yogurt}           0.056   0.22       1.6 
## [4] {whole milk} =&gt; {root vegetables}  0.049   0.19       1.8 
## [5] {whole milk} =&gt; {tropical fruit}   0.042   0.17       1.6</code></pre>
</div>
<div id="item-based" class="section level3">
<h3>Item Based</h3>
<p>We first calculate the similarity of each song with the rest of the songs. This means that we want to compare each column in our âdataMatrixMusicâ data set with every other column in the data set. Specifically, we will define similarity with the âCosine Similarityâ.</p>
<pre class="r"><code>dataMatrixMusic.similarity  &lt;- matrix(NA, nrow=ncol(dataMatrixMusic),ncol=ncol(dataMatrixMusic),dimnames=list(colnames(dataMatrixMusic),colnames(dataMatrixMusic)))

# Loop through the columns
for(i in 1:ncol(dataMatrixMusic)) {
  # Loop through the columns for each column
  for(j in 1:ncol(dataMatrixMusic)) {
    # Fill in placeholder with cosine similarities
    dataMatrixMusic.similarity[i,j]&lt;-getCosine(as.matrix(dataMatrixMusic[i]),as.matrix(dataMatrixMusic[j]))
  }
}
# Back to dataframe
dataMatrixMusic.similarity &lt;- as.data.frame(dataMatrixMusic.similarity)</code></pre>
<pre class="r"><code>dataMatrixMusic.similarity[1:5,1:5]
##                  a.perfect.circle  abba ac.dc adam.green aerosmith
## a.perfect.circle            1.000 0.000 0.018      0.052     0.063
## abba                        0.000 1.000 0.052      0.025     0.061
## ac.dc                       0.018 0.052 1.000      0.113     0.177
## adam.green                  0.052 0.025 0.113      1.000     0.057
## aerosmith                   0.063 0.061 0.177      0.057     1.000</code></pre>
<p>Note: For loops in R are infernally slow. We use as.matrix() to transform the columns into matrices since matrix operations run a lot faster. We transform the similarity matrix into a data.frame for later processes that we will use.</p>
<p>We are now in a position to make recommendations! We look at the top 10 neighbours of each song â those would be the recommendations we make to people listening to those songs. We start off by creating a placeholder and then we need to find the neighbours. This is another loop but runs much faster.</p>
<pre class="r"><code># Get the top 10 neighbours for each
top=10+1
dataMatrix.neighbours &lt;- matrix(NA, nrow=ncol(dataMatrixMusic.similarity),ncol=top,dimnames=list(colnames(dataMatrixMusic.similarity)))
for(i in 1:ncol(dataMatrix.ibs)){
    dataMatrix.neighbours[i,] &lt;-(t(head(n=11,rownames(dataMatrixMusic.similarity[order(dataMatrixMusic.similarity[,i],decreasing=TRUE),][i]))))
}
colnames(dataMatrix.neighbours)&lt;-c(&#39;band&#39;, paste(&#39;top&#39;, c(1:10), sep=&#39;&#39;))
</code></pre>
<pre class="r"><code>kable(dataMatrix.neighbours[1:5,2:top])</code></pre>
<table>
<thead>
<tr class="header">
<th></th>
<th align="left">top1</th>
<th align="left">top2</th>
<th align="left">top3</th>
<th align="left">top4</th>
<th align="left">top5</th>
<th align="left">top6</th>
<th align="left">top7</th>
<th align="left">top8</th>
<th align="left">top9</th>
<th align="left">top10</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>a.perfect.circle</td>
<td align="left">tool</td>
<td align="left">dredg</td>
<td align="left">deftones</td>
<td align="left">porcupine.tree</td>
<td align="left">nine.inch.nails</td>
<td align="left">incubus</td>
<td align="left">system.of.a.down</td>
<td align="left">opeth</td>
<td align="left">the.smashing.pumpkins</td>
<td align="left">radiohead</td>
</tr>
<tr class="even">
<td>abba</td>
<td align="left">madonna</td>
<td align="left">robbie.williams</td>
<td align="left">elvis.presley</td>
<td align="left">michael.jackson</td>
<td align="left">queen</td>
<td align="left">the.beatles</td>
<td align="left">kelly.clarkson</td>
<td align="left">groove.coverage</td>
<td align="left">duffy</td>
<td align="left">mika</td>
</tr>
<tr class="odd">
<td>ac.dc</td>
<td align="left">red.hot.chili.peppers</td>
<td align="left">metallica</td>
<td align="left">iron.maiden</td>
<td align="left">the.offspring</td>
<td align="left">black.sabbath</td>
<td align="left">die.toten.hosen</td>
<td align="left">rammstein</td>
<td align="left">judas.priest</td>
<td align="left">the.beatles</td>
<td align="left">hammerfall</td>
</tr>
<tr class="even">
<td>adam.green</td>
<td align="left">the.libertines</td>
<td align="left">the.strokes</td>
<td align="left">babyshambles</td>
<td align="left">radiohead</td>
<td align="left">franz.ferdinand</td>
<td align="left">the.kooks</td>
<td align="left">foo.fighters</td>
<td align="left">the.white.stripes</td>
<td align="left">the.beatles</td>
<td align="left">arctic.monkeys</td>
</tr>
<tr class="odd">
<td>aerosmith</td>
<td align="left">u2</td>
<td align="left">led.zeppelin</td>
<td align="left">metallica</td>
<td align="left">ac.dc</td>
<td align="left">lenny.kravitz</td>
<td align="left">the.rolling.stones</td>
<td align="left">jack.johnson</td>
<td align="left">red.hot.chili.peppers</td>
<td align="left">robbie.williams</td>
<td align="left">oasis</td>
</tr>
</tbody>
</table>
<p>This means for those listening to Abba we would recommend Madonna and Robbie Williams. Likewise for people listening to ACDC we would recommend the Red Hot Chilli Peppers and Metallica.</p>
</div>
<div id="user-based" class="section level3">
<h3>User Based</h3>
<p>We will need our similarity matrix for User Based recommendations. The process behind creating a score matrix for the User Based recommendations is pretty straight forward:</p>
<ul>
<li>Choose an item and check if a user consumed that item</li>
<li>Get the similarities of that itemâs top X neighbours</li>
<li>Get the consumption record of the user of the top X neighbours</li>
<li>Calculate the score with a formula: sumproduct(purchaseHistory, similarities)/sum(similarities)</li>
</ul>
<p>We can start by creating a helper function to calculate the score mentioned in the last step.</p>
<pre class="r"><code># Lets make a helper function to calculate the scores
  getScore &lt;- function(history, similarities)
  {
    x &lt;- sum(history*similarities)/sum(similarities)
    x
  }</code></pre>
<pre class="r"><code>holder &lt;- matrix(NA, nrow=nrow(dataMatrixMusicUsers),ncol=ncol(dataMatrixMusicUsers)-1,dimnames=list((dataMatrixMusicUsers$user),colnames(dataMatrixMusicUsers[-1]))) 

# Loop through the users (rows)
   for(i in 1:nrow(holder))
   {
       # Loops through the products (columns)
       for(j in 1:ncol(holder))
       {
           # Get the user&#39;s name and th product&#39;s name
             user &lt;- rownames(holder)[i]
             product &lt;- colnames(holder)[j]

           # We do not want to recommend products you have already consumed
           # If you have already consumed it, we store an empty string
             if(as.integer(dataMatrixMusicUsers[dataMatrixMusicUsers$user==user,product]) == 1)
             {
                 holder[i,j]&lt;-&quot;&quot;
              } else {

           # We first have to get a product&#39;s top 10 neighbours sorted by similarity
             topN&lt;-((head(n=11,(dataMatrixMusic.similarity[order(dataMatrixMusic.similarity[,product],decreasing=TRUE),][product]))))
             topN.names &lt;- as.character(rownames(topN))
             topN.similarities &lt;- as.numeric(topN[,1])

           # Drop the first one because it will always be the same
             topN.similarities&lt;-topN.similarities[-1]
             topN.names&lt;-topN.names[-1]

           # We then get the user&#39;s purchase history for those 10 items
             topN.purchases&lt;- dataMatrixMusicUsers[,c(&quot;user&quot;,topN.names)]
             topN.userPurchases&lt;-topN.purchases[topN.purchases$user==user,]
             topN.userPurchases &lt;- as.numeric(topN.userPurchases[!(names(topN.userPurchases) %in% c(&quot;user&quot;))])

            # We then calculate the score for that product and that user
             holder[i,j]&lt;-getScore(similarities=topN.similarities,history=topN.userPurchases)

         } # close else statement
       } # end product for loop
   } # end user for loop

dataMatrixMusic.user.scores &lt;- holder

dataMatrixMusic.user.scores.holder &lt;- matrix(NA, nrow=nrow(dataMatrixMusic.user.scores),ncol=100,dimnames=list(rownames(dataMatrixMusic.user.scores)))
for(i in 1:nrow(dataMatrixMusic.user.scores)){
  dataMatrixMusic.user.scores.holder[i,] &lt;- names(head(n=100,(dataMatrixMusic.user.scores[,order(dataMatrixMusic.user.scores[i,],decreasing=TRUE)])[i,]))
}</code></pre>
<p>The loop starts by taking each user (row) and then jumps into another loop that takes each column (artists). We then store the userâs name and artist name in variables to use them easily later. We then use an if statement to filter out artists that a user has already listened to â this is a business case decision.</p>
<p>The next bit gets the item based similarity scores for the artist under consideration.</p>
<p>It is important to note the number of artists you pick matters. We pick the top 10. We store the similarities score and song names. We also drop the first column because, as we saw, it always represents the same song. Weâre almost there. We just need the userâs purchase history for the top 10 songs.</p>
<p>We use the original data set to get the purchases of our usersâ top 10 purchases. We filter out our current user in the loop and then filter out purchases that match the user. We are now ready to calculate the score and store it in our holder matrix:</p>
<p>Once we are done we can store the results in a data frame. The results should look something like this:</p>
<pre class="r"><code>kable(dataMatrixMusic.user.scores[1:5,1:10])</code></pre>
<table>
<thead>
<tr class="header">
<th></th>
<th align="left">a.perfect.circle</th>
<th align="left">abba</th>
<th align="left">ac.dc</th>
<th align="left">adam.green</th>
<th align="left">aerosmith</th>
<th align="left">afi</th>
<th align="left">air</th>
<th align="left">alanis.morissette</th>
<th align="left">alexisonfire</th>
<th align="left">alicia.keys</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0.204405399744717</td>
<td align="left">0</td>
<td align="left">0.266174512273766</td>
<td align="left">0</td>
<td align="left">0.118139774940785</td>
<td align="left">0.186878798622001</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr class="even">
<td>33</td>
<td align="left">0.0823426024461794</td>
<td align="left">0</td>
<td align="left">0.0959115320210641</td>
<td align="left"></td>
<td align="left">0.0888852208491466</td>
<td align="left">0</td>
<td align="left">0.190638390075421</td>
<td align="left">0.175416279232336</td>
<td align="left">0.069720392848255</td>
<td align="left">0</td>
</tr>
<tr class="odd">
<td>42</td>
<td align="left">0</td>
<td align="left">0.0897665536183953</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr class="even">
<td>51</td>
<td align="left">0.0823426024461794</td>
<td align="left">0.0835681135086085</td>
<td align="left">0</td>
<td align="left">0.0835017734266233</td>
<td align="left">0</td>
<td align="left">0.0929543917995141</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0.0670884792982441</td>
<td align="left">0.081037422331836</td>
</tr>
<tr class="odd">
<td>62</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0.11430458769156</td>
<td align="left">0.0931968819518542</td>
<td align="left">0.0882213669482593</td>
<td align="left">0.0929543917995141</td>
<td align="left">0</td>
<td align="left">0.102627304422923</td>
<td align="left">0.0670884792982441</td>
<td align="left">0</td>
</tr>
</tbody>
</table>
<p>This basically reads that for user 51 we would recommend abba first, then a perfect circle, and we would not recommend ACDC. This is not very pretty â¦ so lets make it pretty: We will create another holder matrix and for each user score we will sort the scores and store the artist names in rank order.</p>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
